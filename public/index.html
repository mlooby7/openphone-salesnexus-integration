<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenPhone to SalesNexus Contact Mapping</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"], input[type="email"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .success {
            background-color: #2ecc71;
        }
        .danger {
            background-color: #e74c3c;
        }
        .warning {
            background-color: #f39c12;
        }
        .message {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .message.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        #mappingsList {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }
        .mapping-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .mapping-item:last-child {
            border-bottom: none;
        }
        .mapping-info {
            flex: 1;
        }
        .phone-number {
            font-weight: bold;
            color: #2c3e50;
        }
        .email {
            color: #3498db;
            margin-left: 10px;
        }
        .contact-details {
            font-size: 0.9em;
            color: #666;
            margin-top: 2px;
        }
        .search-box {
            margin-bottom: 15px;
        }
        .search-box input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .stats {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        .stats h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        .stats p {
            margin: 5px 0;
            font-size: 18px;
            color: #34495e;
        }
        .file-upload-area {
            border: 2px dashed #3498db;
            border-radius: 5px;
            padding: 20px;
            text-align: center;
            background-color: #f8f9fa;
            margin-bottom: 15px;
        }
        .file-upload-area.dragover {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìû OpenPhone to SalesNexus Contact Mapping</h1>
        
        <div class="stats" id="statsSection">
            <h3>üìä Database Status</h3>
            <p id="mappingCount">Loading mapping count...</p>
            <button onclick="refreshStats()">üîÑ Refresh Stats</button>
        </div>

        <!-- Add Single Contact Section -->
        <div class="section">
            <h2>üìù Add Phone Mapping</h2>
            <div class="form-group">
                <label for="phoneNumber">Phone Number (with country code):</label>
                <input type="text" id="phoneNumber" placeholder="e.g., +19046731871" required>
            </div>
            <div class="form-group">
                <label for="emailAddress">Email Address:</label>
                <input type="email" id="emailAddress" placeholder="e.g., contact@company.com" required>
            </div>
            <div class="form-group">
                <label for="contactName">Contact Name (optional):</label>
                <input type="text" id="contactName" placeholder="e.g., John Smith">
            </div>
            <div class="form-group">
                <label for="companyName">Company Name (optional):</label>
                <input type="text" id="companyName" placeholder="e.g., Acme Corp">
            </div>
            <button onclick="addSingleContact()">üìû Add Mapping</button>
            <div id="addContactMessage"></div>
        </div>

        <!-- CSV Upload Section -->
        <div class="section">
            <h2>üìÑ Upload CSV File</h2>
            <div class="file-upload-area" id="csvUploadArea">
                <p>üìÅ Drag and drop your CSV file here, or click to select</p>
                <input type="file" id="csvFile" accept=".csv" style="display: none;">
                <button onclick="document.getElementById('csvFile').click()">Choose CSV File</button>
            </div>
            <div id="csvPreview" style="display: none;">
                <h4>CSV Preview:</h4>
                <div id="csvContent"></div>
                <button onclick="uploadCSV()" class="success">üì§ Upload CSV Mappings</button>
                <button onclick="clearCSV()" class="warning">üóëÔ∏è Clear</button>
            </div>
            <div id="uploadMessage"></div>
            <div class="loading" id="uploadLoading">
                <div class="spinner"></div>
                <p>Processing CSV file...</p>
            </div>
        </div>

        <!-- View Mappings Section -->
        <div class="section">
            <h2>üëÄ View Mappings</h2>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç Search by phone number, email, name, or company..." oninput="searchMappings()">
            </div>
            <button onclick="loadMappings()">üìã Load All Mappings</button>
            <button onclick="clearMappingsList()" class="warning">üóëÔ∏è Clear List</button>
            
            <div id="mappingsCount" style="margin: 15px 0; font-weight: bold;"></div>
            <div id="mappingsList"></div>
            <div class="loading" id="mappingsLoading">
                <div class="spinner"></div>
                <p>Loading mappings...</p>
            </div>
        </div>
    </div>

    <script>
        console.log('OpenPhone to SalesNexus Contact Mapping loaded');

        let currentMappings = [];
        let csvData = null;

        // Load stats when page loads
        window.addEventListener('load', function() {
            refreshStats();
        });

        // CSV file handling
        const csvFile = document.getElementById('csvFile');
        const csvUploadArea = document.getElementById('csvUploadArea');
        const csvPreview = document.getElementById('csvPreview');

        csvFile.addEventListener('change', handleCSVFile);

        // Drag and drop functionality
        csvUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            csvUploadArea.classList.add('dragover');
        });

        csvUploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            csvUploadArea.classList.remove('dragover');
        });

        csvUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            csvUploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                csvFile.files = files;
                handleCSVFile();
            }
        });

        function handleCSVFile() {
            const file = csvFile.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.csv')) {
                showMessage('uploadMessage', 'Please select a CSV file.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                csvData = e.target.result;
                displayCSVPreview(csvData);
            };
            reader.readAsText(file);
        }

        function displayCSVPreview(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim());
            const previewLines = lines.slice(0, 6); // Show first 6 lines

            let preview = '<pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto;">';
            previewLines.forEach((line, index) => {
                if (index === 0) {
                    preview += `<strong>${line}</strong>\n`;
                } else {
                    preview += `${line}\n`;
                }
            });
            if (lines.length > 6) {
                preview += `... and ${lines.length - 6} more rows`;
            }
            preview += '</pre>';

            document.getElementById('csvContent').innerHTML = preview;
            csvPreview.style.display = 'block';
        }

        function clearCSV() {
            csvFile.value = '';
            csvData = null;
            csvPreview.style.display = 'none';
            document.getElementById('uploadMessage').innerHTML = '';
        }

        async function refreshStats() {
            try {
                const response = await fetch('/.netlify/functions/mapping/count');
                const data = await response.json();
                
                if (response.ok && data.count !== undefined) {
                    document.getElementById('mappingCount').textContent = `Total Phone Mappings: ${data.count}`;
                } else {
                    document.getElementById('mappingCount').textContent = 'Unable to load mapping count';
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('mappingCount').textContent = 'Error loading stats';
            }
        }

        async function addSingleContact() {
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            const emailAddress = document.getElementById('emailAddress').value.trim();
            const contactName = document.getElementById('contactName').value.trim();
            const companyName = document.getElementById('companyName').value.trim();

            if (!phoneNumber || !emailAddress) {
                showMessage('addContactMessage', 'Please fill in both phone number and email address.', 'error');
                return;
            }

            if (!emailAddress.includes('@')) {
                showMessage('addContactMessage', 'Please enter a valid email address.', 'error');
                return;
            }

            try {
                const response = await fetch('/.netlify/functions/mapping', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'addMapping',
                        phoneNumber,
                        email: emailAddress,
                        contactName,
                        companyName,
                        phoneType: 'Manual Entry'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('addContactMessage', `‚úÖ Successfully added mapping: ${phoneNumber} ‚Üí ${emailAddress}`, 'success');
                    // Clear form
                    document.getElementById('phoneNumber').value = '';
                    document.getElementById('emailAddress').value = '';
                    document.getElementById('contactName').value = '';
                    document.getElementById('companyName').value = '';
                    // Refresh stats
                    refreshStats();
                } else {
                    throw new Error(data.error || 'Failed to add contact');
                }
            } catch (error) {
                console.error('Add contact error:', error);
                showMessage('addContactMessage', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function uploadCSV() {
            if (!csvData) {
                showMessage('uploadMessage', 'Please select a CSV file first.', 'error');
                return;
            }

            document.getElementById('uploadLoading').style.display = 'block';

            try {
                const response = await fetch('/.netlify/functions/mapping', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'uploadMappings',
                        csvData: csvData
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('uploadMessage', `‚úÖ ${data.message}`, 'success');
                    clearCSV();
                    refreshStats();
                } else {
                    throw new Error(data.error || 'Failed to upload CSV');
                }
            } catch (error) {
                console.error('CSV upload error:', error);
                showMessage('uploadMessage', `‚ùå Error: ${error.message}`, 'error');
            } finally {
                document.getElementById('uploadLoading').style.display = 'none';
            }
        }

        async function loadMappings() {
            document.getElementById('mappingsLoading').style.display = 'block';
            document.getElementById('mappingsList').innerHTML = '';

            try {
                const response = await fetch('/.netlify/functions/mapping', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'getMappings',
                        search: ''
                    })
                });

                const data = await response.json();

                if (response.ok && data.mappings) {
                    currentMappings = data.mappings;
                    displayMappings(currentMappings);
                } else {
                    throw new Error(data.error || 'Failed to load mappings');
                }
            } catch (error) {
                console.error('Load mappings error:', error);
                document.getElementById('mappingsList').innerHTML = `<div class="message error">‚ùå Error loading mappings: ${error.message}</div>`;
            } finally {
                document.getElementById('mappingsLoading').style.display = 'none';
            }
        }

        function searchMappings() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            
            if (!searchTerm) {
                displayMappings(currentMappings);
                return;
            }

            const filteredMappings = currentMappings.filter(mapping => {
                return (mapping.phoneNumber && mapping.phoneNumber.toLowerCase().includes(searchTerm)) ||
                       (mapping.email && mapping.email.toLowerCase().includes(searchTerm)) ||
                       (mapping.contactName && mapping.contactName.toLowerCase().includes(searchTerm)) ||
                       (mapping.companyName && mapping.companyName.toLowerCase().includes(searchTerm));
            });

            displayMappings(filteredMappings);
        }

        function displayMappings(mappings) {
            const mappingsList = document.getElementById('mappingsList');
            const mappingsCount = document.getElementById('mappingsCount');

            if (mappings.length === 0) {
                mappingsList.innerHTML = '<div class="message warning">üì≠ No mappings found.</div>';
                mappingsCount.textContent = '';
                return;
            }

            mappingsCount.textContent = `üìä Showing ${mappings.length} mapping(s)`;

            const mappingsHTML = mappings.map(mapping => {
                const contactInfo = [mapping.contactName, mapping.companyName].filter(Boolean).join(' - ');
                const phoneType = mapping.phoneType || 'Unknown';
                
                return `
                    <div class="mapping-item">
                        <div class="mapping-info">
                            <div>
                                <span class="phone-number">${mapping.phoneNumber}</span>
                                <span class="email">${mapping.email}</span>
                            </div>
                            ${contactInfo ? `<div class="contact-details">üë§ ${contactInfo} | üì± ${phoneType}</div>` : `<div class="contact-details">üì± ${phoneType}</div>`}
                        </div>
                    </div>
                `;
            }).join('');

            mappingsList.innerHTML = mappingsHTML;
        }

        function clearMappingsList() {
            document.getElementById('mappingsList').innerHTML = '';
            document.getElementById('mappingsCount').textContent = '';
            document.getElementById('searchInput').value = '';
            currentMappings = [];
        }

        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            // Auto-clear success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    element.innerHTML = '';
                }, 5000);
            }
        }
    </script>
</body>
</html>
